<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Causal RAG Explorer — System Architecture</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      securityLevel: 'loose',
      flowchart: {
        htmlLabels: true,
        curve: 'basis',
        padding: 8
      }
    });
  </script>
  <style>
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color: #e6eaf2; background: #0b1020; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 16px 48px; }
    h1 { margin: 0 0 10px; font-size: 24px; font-weight: 800; }
    .sub { color: #a5b0c2; margin-bottom: 18px; }
    .card { background: #141a2f; border: 1px solid #2a3253; border-radius: 12px; padding: 16px; }
    .mermaid { background: #0f1530; border: 1px solid #242c4a; border-radius: 12px; padding: 16px; }
    .legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 10px; margin-top: 12px; color: #cfd6e6; }
    .pill { border: 1px solid #2a3253; border-radius: 999px; padding: 6px 10px; background: #101737; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>System Architecture</h1>
    <div class="sub">End-to-end dataflow for ingestion → indexing → router-aware retrieval → optional reranking → UI/LLM.</div>
    <div class="card">
      <div class="mermaid">
flowchart TB
  %% Subgraphs represent major stages
  subgraph ING[Ingestion]
    A1[ingestion/seed_corpus.py] -->|writes| A2[data/corpus.jsonl]
  end

  subgraph IDX[Indexing]
    B1[indexing/build_bm25.py] -->|build| B2[artifacts/bm25_index.pkl]
    B3[indexing/build_hybrid.py] -->|build| B4[artifacts/faiss_index.bin]
    B3 -->|hybrid config| B5[artifacts/hybrid_index.pkl]
  end

  subgraph RTR[Router]
    C1[router/router.py route_query] --> C2[router tags: lane/domain/method]
  end

  subgraph RET[Retrieval]
    D1[retrieval/query.py BM25 + boosts] --> D2[top-N candidates with scores]
    D1 -->|loads| B2
    D1 -->|reads| A2
    C2 -->|bias/boosts| D1
  end

  subgraph RR[Reranker optional]
    E1[retrieval/reranker.py CrossEncoder] --> E2[rerank_score]
  end

  subgraph UI[UI and Synthesis]
    F1[ui/app.py Streamlit]
    F3[LLM synthesis Day 8]
  end

  subgraph EVAL[Evaluation Week 2]
    G1[eval/qa.jsonl]
    G2[metrics Recall@k MRR Faithfulness]
  end

  %% Dataflow
  A2 --> B1
  A2 --> B3
  F1 -->|query text| C1
  C2 --> D1
  D2 -->|top-20| E1
  E1 --> E2
  D2 -. no rerank .-> F1
  E2 -->|top-5| F1
  F1 -->|synthesis prompt| F3
  G1 -. evaluate .-> D2
  G2 -. report .-> F1

  %% Styling
  classDef storage fill:#1d2340,stroke:#3f4b84,color:#dbe4ff;
  classDef stage fill:#0f1530,stroke:#4052a5,color:#e6eaf2;
  classDef code fill:#172145,stroke:#5462b4,color:#e6eaf2;
  class A2,B2,B4,B5,F3 storage
  class ING,IDX,RTR,RET,RR,UI,EVAL stage
  class A1,B1,B3,C1,D1,E1,F1,G1,G2 code
      </div>
      <div class="legend">
        <div class="pill">Ingestion → write curated JSONL corpus</div>
        <div class="pill">Indexing → BM25 / FAISS / hybrid artifacts</div>
        <div class="pill">Router → lane/domain/method tags + confidence</div>
        <div class="pill">Retrieval → BM25 scores + boosts (domain/method/venue/recency)</div>
        <div class="pill">Reranker → cross-encoder reorders top-N to top-5</div>
        <div class="pill">UI/LLM → Streamlit app, synthesis with citations (Day 8)</div>
        <div class="pill">Eval → Recall@k, MRR, Faithfulness with qa.jsonl</div>
      </div>
    </div>
  </div>
</body>
</html>


